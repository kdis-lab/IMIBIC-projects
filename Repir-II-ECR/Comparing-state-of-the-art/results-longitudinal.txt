
R version 3.4.4 (2018-03-15) -- "Someone to Lean On"
Copyright (C) 2018 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

> library(boostmtree)

 boostmtree 1.3.0 
 
 Type boostmtree.news() to see new features, changes, and bug fixes. 
 

> library(htree)
Loading required package: parallel
htree 2.0.0
> library(REEMtree)
Loading required package: nlme
Loading required package: rpart
> library(lme4)
Loading required package: Matrix

Attaching package: ‘lme4’

The following object is masked from ‘package:nlme’:

    lmList

> library(caret)
Loading required package: lattice
Loading required package: ggplot2
> 
> # SE TRATA DE PREDECIR EL SIGUIENTE VALOR DE FG. POR ESO ANTES QUE TODO EL DATASET HA DE TRANSFORMARSE PARA QUE 
> # POR CADA REGISTRO SE TENGA EL SIGUIENTE VALOR DE FG Y NO EL ALTUAL, YA QUE EL ACTUAL SE PUEDE CALCULAR DIRECTAMENTE A PARTIR DE LAS COVARIABLES
> 
> # YA EN ESTE DATASET NO HAY NINGUN PACIENTE CON 1 SOLA VISITA
> 
> # Se siguio el proceso de CV explicado aqui, llamado forward chaining
> #https://towardsdatascience.com/time-series-nested-cross-validation-76adba623eb9
> 
> # Funcion que transforma el dataset. Se anade una nueva columna del siguiente filtrado glomerular
> transform_dataset <- function(dataset){
+   
+   new.dataset <- data.frame(matrix(ncol = ncol(dataset)+1, nrow = 0))
+   
+   colnames(new.dataset) <- c(colnames(dataset), "next_Filtrado_glomerular")
+   
+   ids <- unique(dataset$Id)
+   
+   for(id in ids){
+     
+     # Extract subset associated for id
+     rows <- dataset[dataset$Id==id,]
+     
+     for(row_index in 1:(nrow(rows)-1)){
+       
+       new.row <-c(rows[row_index,], rows[row_index+1, "Filtrado_glomerular"]) # se adiciona el siguiente filtrado
+       names(new.row) <- colnames(new.dataset)
+       
+       new.dataset <- rbind(new.dataset, new.row)  
+       
+     }
+     
+   }
+   
+   return(new.dataset)
+   
+ }
> 
> split_train_test <- function(dataset, nvisits){
+   
+   train <- data.frame(matrix(ncol = ncol(dataset), nrow = 0))
+   test <- data.frame(matrix(ncol = ncol(dataset), nrow = 0))
+   
+   colnames(train) <- colnames(dataset)
+   colnames(test) <- colnames(dataset)
+   
+   ids <- unique(dataset$Id)
+   
+   # For each patient
+   for(id in ids){
+     
+     # Extract subset associated for id
+     
+     rows <- dataset[dataset$Id==id,]
+     
+     nvisitsT <- nvisits
+     
+     if (nrow(rows) < nvisits){
+       
+       nvisitsT <- nrow(rows)
+     }
+     
+     rows_training <- rows[1: nvisitsT,]
+     train <- rbind(train, rows_training)
+     
+     if(nvisitsT < nrow(rows)){
+       
+       # Select the next visit
+       rows_test <- rows[nvisitsT + 1, ]
+       test <- rbind(test, rows_test)
+     }
+   }
+   
+   return(list("train"= train, "test" = test))
+ }
> 
> dataset <- read.csv("datasets/datos-demograficos-visitas-tratamientos-missing-imputation-mean-average_before_after_values-allnumerics.csv", header = T, na.strings = "")
> 
> dataset <- transform_dataset(dataset)
> 
> original_numeric <- read.csv("datasets/original_columns_numeric.csv", header = T, na.strings = "")
> 
> original_numeric <- c(as.character(original_numeric$Column), "next_Filtrado_glomerular")
> 
> nmax = max(table(dataset$Id))
> 
> num_features = ncol(dataset)-1
> 
> results = list(BOOSTMTREE=c(), HTREE = c(), RFOREST= c(), REEMTREE= c(), LME= c())
> 
> for(nvisit in 1:(nmax-1)){
+   
+   data.split <- split_train_test(dataset, nvisit)
+   
+   dta_train <-data.split[["train"]]
+   dta_test <-data.split[["test"]]
+   
+   preProcValues <- preProcess(dta_train[,original_numeric], method = c("center", "scale"))
+   
+   dta_train[,original_numeric] <- predict(preProcValues, dta_train[,original_numeric])
+   dta_test[,original_numeric] <- predict(preProcValues, dta_test[,original_numeric])
+   
+   dta_train.features <- dta_train[, c(2:51, 53:71)]
+   dta_train.time <- dta_train$Tiempo_evolucion
+   dta_train.id <- dta_train$Id
+   dta_train.y <- dta_train$next_Filtrado_glomerular
+   
+   dta_test.features <- dta_test[, c(2:51, 53:71)]
+   dta_test.time <- dta_test$Tiempo_evolucion
+   dta_test.id <- dta_test$Id
+   dta_test.y <- dta_test$next_Filtrado_glomerular
+   
+   # BOOSTMTREE
+   modelp <- boostmtree(x= dta_train.features, tm = dta_train.time, id = dta_train.id, y = dta_train.y, M = 20)
+   
+   p <-predict(modelp, x = dta_test.features, id= dta_test.id, tm= dta_test.time, y= dta_test.y)
+   
+   p <-unlist(p$mu)
+   
+   results$BOOSTMTREE <- c(results$BOOSTMTREE, RMSE(p,dta_test.y))
+   
+   # HTREE
+   dta_train.features <- dta_train[, c(2:51, 53:72)]
+   modelp <- htb(x=dta_train.features, id= dta_train.id, time= dta_train.time, yindx= "next_Filtrado_glomerular", lambda=.1, nsplit=3, ntrees=200)
+   
+   dta_test.features <- dta_test[, c(2:51, 53:72)]
+   p <- predict_htb(modelp, x= dta_test.features, type = "response", time= dta_test.time, id = dta_test.id)
+   
+   results$HTREE <- c(results$HTREE, RMSE(p, dta_test.y))
+    
+   # RFOREST
+   modelp <- hrf(x=dta_train.features, id= dta_train.id, time= dta_train.time, yindx= "next_Filtrado_glomerular")
+   
+   p <- predict_hrf(modelp, x = dta_test.features, time= dta_test.time, id = dta_test.id)
+   
+   results$RFOREST <- c(results$RFOREST , RMSE(p, dta_test.y))
+   
+   # REEMTREE
+   form <- as.formula(paste0("next_Filtrado_glomerular ~ ", paste(colnames(dta_train)[c(2:51, 53:71)], collapse = " + ")))
+   
+   modelp <- REEMtree(form, data= dta_train, random= ~ 1 + Tiempo_evolucion|Id)
+   
+   p <- predict(modelp, dta_test, EstimateRandomEffects = FALSE, id = "Id")
+   
+   results$REEMTREE <- c(results$REEMTREE , RMSE(p, dta_test.y))
+   
+   if(nvisit > 1){
+     
+     # LME
+   
+     form <- as.formula(paste0("next_Filtrado_glomerular ~ ", 
+                             paste(colnames(dta_train)[c(2:71)], collapse = " + "), " + (1|Id)"))
+   
+     modelp <- lmer(form, data = dta_train)
+   
+     p <- predict(modelp, newdata = dta_test, allow.new.levels = TRUE)
+     
+     results$LME <- c(results$LME , RMSE(p, dta_test.y))
+   }
+ }
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
  |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%
fixed-effect model matrix is rank deficient so dropping 4 columns / coefficients
boundary (singular) fit: see ?isSingular
There were 18 warnings (use warnings() to see them)
> 
> print("BOOSTMTREE")
[1] "BOOSTMTREE"
> print(paste0("Mean: ", mean(results$BOOSTMTREE)))
[1] "Mean: 0.572692739181514"
> print(paste0("Std: ", sd(results$BOOSTMTREE)))
[1] "Std: 0.064295672251598"
> 
> print("***********************")
[1] "***********************"
> 
> print("HTREE")
[1] "HTREE"
> print(paste0("Mean: ", mean(results$HTREE)))
[1] "Mean: 0.442303498612962"
> print(paste0("Std: ", sd(results$HTREE)))
[1] "Std: 0.173507272633257"
> 
> print("***********************")
[1] "***********************"
> 
> print("RFOREST")
[1] "RFOREST"
> print(paste0("Mean: ", mean(results$RFOREST)))
[1] "Mean: 0.488321299943663"
> print(paste0("Std: ", sd(results$RFOREST)))
[1] "Std: 0.138255217450187"
> 
> print("***********************")
[1] "***********************"
> 
> print("REEMTREE")
[1] "REEMTREE"
> print(paste0("Mean: ", mean(results$REEMTREE)))
[1] "Mean: 0.457282269694849"
> print(paste0("Std: ", sd(results$REEMTREE)))
[1] "Std: 0.16990175159161"
> 
> print("***********************")
[1] "***********************"
> 
> print("LME")
[1] "LME"
> print(paste0("Mean: ", mean(results$LME)))
[1] "Mean: 0.426061643065804"
> print(paste0("Std: ", sd(results$LME)))
[1] "Std: 0.149257329573464"
> 
> 
